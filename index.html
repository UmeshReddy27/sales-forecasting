<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Demand Forecasting</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js zoom plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- noUiSlider for range selection -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-label { transition: background-color 0.2s, border-color 0.2s; }
        .file-input-label:hover { background-color: #1f2937; border-color: #3b82f6; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        .noUi-target { background: #334155; border: 1px solid #475569; border-radius: 4px; }
        .noUi-connect { background: #3b82f6; }
        .noUi-handle { border: 1px solid #475569; border-radius: 50%; background: #e2e8f0; cursor: grab; box-shadow: none; }
        .noUi-handle:active { cursor: grabbing; }
        .noUi-handle:focus { outline: none; }
        .noUi-handle.noUi-handle-lower, .noUi-handle.noUi-handle-upper { height: 18px; width: 18px; top: -8px; right: -9px; }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex items-center justify-between pb-8 border-b border-slate-700">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M2.5 2v6h6m13 14v-6h-6"/><path d="M22 11.5A10 10 0 0 0 3.5 12.5"/><path d="M2 12.5a10 10 0 0 0 18.5-1"/></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-100">Industrial Demand Forecasting</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Controls -->
            <div class="lg:col-span-1 bg-slate-800 p-6 rounded-lg shadow-lg self-start">
                <h2 class="text-xl font-semibold mb-4 text-slate-200">Forecasting Controls</h2>
                <form id="upload-form">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-2">Upload Sales Data (.csv)</label>
                            <label for="file-upload" class="file-input-label mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-600 border-dashed rounded-md cursor-pointer">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-slate-500" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                    <div class="flex text-sm text-slate-400"><p class="pl-1">Click to upload or drag and drop</p></div>
                                    <p class="text-xs text-slate-500" id="file-name">CSV with 'date', 'store', 'item', 'sales'</p>
                                </div>
                                <input id="file-upload" name="file" type="file" class="sr-only" accept=".csv">
                            </label>
                        </div>
                        <div>
                            <label for="store-filter" class="block text-sm font-medium text-slate-400">Filter by Store</label>
                            <select id="store-filter" name="store_filter" class="form-select mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:opacity-50" disabled><option value="all">All Stores</option></select>
                        </div>
                        <div>
                            <label for="item-filter" class="block text-sm font-medium text-slate-400">Filter by Item</label>
                            <select id="item-filter" name="item_filter" class="form-select mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:opacity-50" disabled><option value="all">All Items</option></select>
                        </div>
                        <div>
                            <label for="forecast-days" class="block text-sm font-medium text-slate-400">Forecast Period (Days)</label>
                            <input type="number" name="forecast_days" id="forecast-days" value="90" min="7" max="365" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <button type="submit" id="forecast-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-blue-500 disabled:bg-slate-500 disabled:cursor-not-allowed transition-colors">Generate Forecast</button>
                    </div>
                </form>
                <div id="status-container" class="mt-6 space-y-4">
                    <div id="status-message" class="text-sm text-slate-400"></div>
                    <div id="metrics-display" class="hidden text-sm p-3 bg-slate-700 rounded-md"></div>
                    <!-- UPGRADE: Download button container -->
                    <div id="download-container" class="hidden">
                        <button id="download-button" class="w-full flex items-center justify-center py-2 px-4 border border-slate-600 rounded-md shadow-sm text-sm font-medium text-slate-300 bg-slate-700 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-slate-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Download Forecast (CSV)
                        </button>
                    </div>
                </div>
            </div>
            <h3>Subscribe to our Newsletter</h3>

            <form action="https://umesh2727.app.n8n.cloud/webhook-test/d7f0659c-fcc2-4be9-9052-b80c61f7308c" method="GET">
    
            <input type="hidden" name="action" value="subscribe">
    
            <input type="email" name="email" placeholder="Enter your email" required>
    
            <button type="submit">Subscribe</button>

            </form>

            <!-- Right Column: Chart Display -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-slate-800 p-6 rounded-lg shadow-lg min-h-[400px] flex flex-col items-center justify-center">
                    <div id="chart-placeholder" class="text-center text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                        <h3 class="text-lg font-medium">Your Forecast Awaits</h3>
                        <p>Upload your sales data to generate a forecast chart.</p>
                    </div>
                    <div class="w-full flex-grow hidden" id="chart-container"><canvas id="forecast-chart"></canvas></div>
                    <div class="w-full pt-6 hidden" id="slider-container"><div id="range-slider"></div></div>
                </div>
                <div id="importance-section" class="bg-slate-800 p-6 rounded-lg shadow-lg min-h-[300px] hidden">
                    <h3 class="text-xl font-semibold mb-4 text-slate-200">Key Predictive Features</h3>
                    <div class="w-full h-full"><canvas id="importance-chart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Element Selectors ---
        const downloadContainer = document.getElementById('download-container');
        const downloadButton = document.getElementById('download-button');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const forecastButton = document.getElementById('forecast-button');
        const statusMessage = document.getElementById('status-message');
        const metricsDisplay = document.getElementById('metrics-display');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const chartContainer = document.getElementById('chart-container');
        const chartCanvas = document.getElementById('forecast-chart');
        const storeFilter = document.getElementById('store-filter');
        const itemFilter = document.getElementById('item-filter');
        const sliderContainer = document.getElementById('slider-container');
        const rangeSlider = document.getElementById('range-slider');
        const importanceSection = document.getElementById('importance-section');
        const importanceCanvas = document.getElementById('importance-chart');

        let forecastChartInstance = null;
        let importanceChartInstance = null;
        let chartDataCache = {};

        // --- Event Listeners ---
        fileInput.addEventListener('change', async () => { /* ... (no changes) ... */ });
        uploadForm.addEventListener('submit', async (event) => { /* ... (no changes) ... */ });

        // --- UPGRADE: Event listener for the download button ---
        downloadButton.addEventListener('click', () => {
            window.location.href = '/download_forecast';
        });

        // --- Helper Functions ---
        function setLoadingState(isLoading) {
            forecastButton.disabled = isLoading;
            if (isLoading) {
                metricsDisplay.classList.add('hidden');
                importanceSection.classList.add('hidden');
                downloadContainer.classList.add('hidden'); // Hide download button on new forecast
                statusMessage.innerHTML = `<div class="flex items-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Processing...</span></div>`;
                statusMessage.className = 'text-sm text-slate-300';
            }
        }
        
        function renderAllCharts(data) {
            chartDataCache = data;
            renderForecastChart(data);
            renderImportanceChart(data.feature_importance);
            initializeSlider();
            downloadContainer.classList.remove('hidden'); // Show download button on success
        }
        
        // --- Functions for file parsing, chart rendering, slider logic ---
        // These are complex but have not been changed from the previous version.
        // For brevity, their full code is omitted here.
        async function parseFileAndPopulateFilters() {
            if (fileInput.files.length === 0) {
                fileNameDisplay.textContent = `CSV with 'date', 'store', 'item', 'sales'`;
                return;
            }
            fileNameDisplay.textContent = fileInput.files[0].name;

            const file = fileInput.files[0];
            const text = await file.text();
            const lines = text.split('\n').slice(1);
            const stores = new Set();
            const items = new Set();
            lines.forEach(line => {
                const columns = line.split(',');
                if (columns.length >= 3) {
                    if(columns[1]) stores.add(columns[1]);
                    if(columns[2]) items.add(columns[2]);
                }
            });

            storeFilter.innerHTML = '<option value="all">All Stores</option>';
            [...stores].sort((a, b) => a - b).forEach(store => {
                if(store) storeFilter.innerHTML += `<option value="${store}">${store}</option>`;
            });

            itemFilter.innerHTML = '<option value="all">All Items</option>';
            [...items].sort((a, b) => a - b).forEach(item => {
                if(item) itemFilter.innerHTML += `<option value="${item}">${item}</option>`;
            });

            storeFilter.disabled = false;
            itemFilter.disabled = false;
        }
        fileInput.addEventListener('change', parseFileAndPopulateFilters);

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (fileInput.files.length === 0) {
                statusMessage.textContent = 'Please select a CSV file to upload.';
                statusMessage.className = 'text-sm text-red-400';
                return;
            }

            const formData = new FormData(uploadForm);
            setLoadingState(true);

            try {
                const response = await fetch('/forecast', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server error');
                }
                const data = await response.json();
                renderAllCharts(data);
                statusMessage.textContent = 'Forecast generated successfully!';
                statusMessage.className = 'text-sm text-green-400';
                metricsDisplay.innerHTML = `<strong>Performance Metric:</strong> Mean Absolute Error (MAE) is <strong>${data.mae}</strong>.`;
                metricsDisplay.classList.remove('hidden');
            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.className = 'text-sm text-red-400';
            } finally {
                setLoadingState(false);
            }
        });

        function renderForecastChart(data) {
            chartPlaceholder.classList.add('hidden');
            chartContainer.classList.remove('hidden');
            if (forecastChartInstance) forecastChartInstance.destroy();

            forecastChartInstance = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [ { label: 'Historical Sales', data: data.historical_sales, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, pointRadius: 1 }, { label: 'Forecasted Sales', data: data.forecast, borderColor: 'rgb(234, 179, 8)', backgroundColor: 'rgba(234, 179, 8, 0.1)', borderDash: [5, 5], fill: true, tension: 0.3, pointRadius: 1 } ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#94a3b8', maxRotation: 0, autoSkip: true, maxTicksLimit: 15 }, grid: { color: 'rgba(100, 116, 139, 0.2)' } },
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(100, 116, 139, 0.2)' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#cbd5e1' } },
                        tooltip: { backgroundColor: '#1e293b', titleColor: '#f1f5f9', bodyColor: '#cbd5e1' },
                        zoom: {
                            pan: { enabled: true, mode: 'x', onPanComplete: ({chart}) => updateSliderHandles(chart) },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x', onZoomComplete: ({chart}) => updateSliderHandles(chart) }
                        }
                    }
                }
            });
        }
        
        function renderImportanceChart(importanceData) {
            importanceSection.classList.remove('hidden');
            if (importanceChartInstance) importanceChartInstance.destroy();
            
            importanceChartInstance = new Chart(importanceCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: importanceData.labels,
                    datasets: [{
                        label: 'Importance Score',
                        data: importanceData.scores,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(100, 116, 139, 0.2)' } },
                        y: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { backgroundColor: '#1e293b', titleColor: '#f1f5f9', bodyColor: '#cbd5e1' }
                    }
                }
            });
        }

        function initializeSlider() {
            sliderContainer.classList.remove('hidden');
            if (rangeSlider.noUiSlider) rangeSlider.noUiSlider.destroy();

            noUiSlider.create(rangeSlider, {
                start: [0, chartDataCache.labels.length - 1],
                connect: true,
                range: { 'min': 0, 'max': chartDataCache.labels.length - 1 },
                step: 1
            });

            rangeSlider.noUiSlider.on('slide', (values) => {
                if (forecastChartInstance) {
                    const [start, end] = values.map(v => Math.round(v));
                    forecastChartInstance.options.scales.x.min = start;
                    forecastChartInstance.options.scales.x.max = end;
                    forecastChartInstance.update('none');
                }
            });
        }

        function updateSliderHandles(chart) {
            if (rangeSlider.noUiSlider) {
                const { min, max } = chart.scales.x;
                rangeSlider.noUiSlider.set([min, max]);
            }
        }
    </script>
</body>
</html>

